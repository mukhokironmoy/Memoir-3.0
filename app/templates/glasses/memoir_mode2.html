<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Memoir Mode</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='glasses.css') }}"
    />
    <style>
      .glass {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1rem;
      }
      .overlay {
        position: fixed;
        z-index: 1040;
      }
      #videoBackground {
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        object-fit: cover;
        z-index: 0;
      }
      .pfp {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
      .cursor-pointer {
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-black text-white">
    <!-- Webcam Video Background -->
    <video id="videoBackground" autoplay muted playsinline></video>
    <canvas id="overlayCanvas"></canvas>

    <!-- Top-left Clock -->
    <div class="overlay top-0 start-0 p-3 p-sm-4">
      <div class="glass p-3">
        <div id="timeText" class="h4 fw-semibold mb-1">--:--:--</div>
        <div id="dateText" class="small text-uppercase">Loading date…</div>
      </div>
    </div>

    <!-- Top-right Sidebar Toggle -->
    <div class="overlay top-0 end-0 p-3 p-sm-4">
      <button
        class="btn btn-outline-light"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#memoirSidebar"
        aria-controls="memoirSidebar"
      >
        ☰
      </button>
    </div>

    <!-- Sidebar -->
    <div
      class="offcanvas offcanvas-end show glass text-white"
      tabindex="-1"
      id="memoirSidebar"
      style="visibility: visible; width: 320px"
      aria-modal="true"
      role="dialog"
    >
      <div class="offcanvas-body">
        <!-- Fixed button header -->
        <div id="sidebarHeader"></div>

        <br />

        <!-- Dynamic title per view -->
        <div id="sidebarTitle" class="text-center fw-bold my-2"></div>

        <!-- View content -->
        <div id="sidebarContent"></div>
      </div>
    </div>

    <!-- ===== View Templates ===== -->
    {% raw %}

    <!-- Home View -->
    <template id="tpl-home">
      <div id="homeActiveConvo" class="mb-3 d-none">
        <button
          class="btn btn-primary w-100"
          data-action="return-to-conversation"
        >
          Return to Active Conversation
        </button>
      </div>

      <div class="list-group list-group-flush">
        <button
          class="list-group-item glass text-white mb-2"
          data-action="view-contacts"
        >
          View Contacts
        </button>
        <button
          class="list-group-item glass text-white mb-2"
          data-action="visit-memory-bank"
        >
          Visit Memory Bank
        </button>
      </div>
    </template>

    <!-- Contacts List View -->
    <template id="tpl-contacts">
      <div id="contactsList" class="mt-2">
        <!-- JS injects list of contacts -->
      </div>
    </template>

    <!-- Profile View -->
    <template id="tpl-profile">
      <div id="convStatusChip" class="mb-2 d-none">
        <span class="badge bg-danger">Recording in background</span>
      </div>

      <div class="text-center my-3">
        <img
          src="{{avatar}}"
          alt="pfp"
          class="pfp shadow-sm"
          onerror="this.onerror=null;this.src='https://via.placeholder.com/160x160.png?text=?';"
        />
      </div>

      <div class="mb-3 small text-white-75">
        <div><strong>Name:</strong> {{name}}</div>
        <div><strong>Relation:</strong> {{relation}}</div>
        <div><strong>Last met:</strong> {{lastMetPretty}}</div>
      </div>

      <!-- When NOT recording -->
      <div id="profileBtnsIdle">
        <button
          id="startBtn"
          class="btn btn-success w-100 mt-2"
          data-action="start-conversation"
          data-person-id="{{id}}"
        >
          Start Conversation
        </button>

        <button
          id="enrollBtn"
          class="btn btn-outline-success w-100 mt-2"
          data-action="enroll-current-face"
          data-person-id="{{id}}"
        >
          Enroll current face
        </button>
      </div>

      <!-- When recording (background) -->
      <div id="profileBtnsActive" class="d-none">
        <button
          class="btn btn-primary w-100 mt-2"
          data-action="return-to-conversation"
        >
          Return to Conversation
        </button>
        <button
          class="btn btn-danger w-100 mt-2"
          data-action="stop-conversation"
        >
          Stop Conversation
        </button>
      </div>

      <hr class="border-secondary" />

      <!-- Summary -->
      <div class="small">
        <div class="fw-semibold mb-2">Summary of last conversation:</div>
        <ul id="summaryList" class="mb-0">
          <!-- JS will inject <li> items here -->
        </ul>
      </div>

      <!-- View more info BELOW the summary -->
      <button
        class="btn btn-outline-light w-100 mt-3"
        data-action="view-more-info"
      >
        View more info
      </button>
    </template>

    <!-- Conversation View -->
    <template id="tpl-conversation">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span id="activeSpeakerChip" class="badge bg-light text-dark"
          >Active: {{activeSpeaker}}</span
        >
        <span id="micStatusChip" class="badge bg-success">Mic: Live</span>
      </div>

      <div
        class="btn-group w-100 mb-3"
        role="group"
        aria-label="Speaker toggle"
      >
        <input
          type="radio"
          class="btn-check"
          name="speaker"
          id="speakerPatient"
          autocomplete="off"
        />
        <label
          class="btn btn-outline-light"
          for="speakerPatient"
          data-action="set-speaker"
          data-speaker="Patient"
          >Patient</label
        >

        <input
          type="radio"
          class="btn-check"
          name="speaker"
          id="speakerVisitor"
          autocomplete="off"
        />
        <label
          class="btn btn-outline-light"
          for="speakerVisitor"
          data-action="set-speaker"
          data-speaker="Visitor"
          >Visitor</label
        >
      </div>

      <div id="transcriptArea" class="small text-white-50">
        <em>Live transcript will appear here…</em>
      </div>

      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-warning" data-action="pause-resume-conversation">
          Pause
        </button>
        <button class="btn btn-danger" data-action="stop-conversation">
          Stop Conversation
        </button>
      </div>
    </template>

    {% endraw %}

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Face API.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- App -->
    <script src="{{ url_for('static', filename='glasses2.js') }}"></script>
  </body>
</html>
